void qcms_data_create_rgb_with_gamma(qcms_CIE_xyY white_point, qcms_CIE_xyYTRIPLE primaries, float gamma, void **mem, size_t *size) uint32_t length , offset , index , xyz_count , trc_count ; void * data ; if ( ( mem == NULL ) || ( size == NULL ) )  xyz_count = 3; trc_count = 3; length = ICC_PROFILE_HEADER_LENGTH + 4 + ( 12 * ( xyz_count + trc_count ) ) + ( xyz_count * 20 ) + ( trc_count * 16 ); data = malloc ( length ); if ( ! data )  memset ( data , 0 , length ); free ( data ); write_u32 ( data , tag_table_offset , TAG_XYZ [ index ] ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); static be32 cpu_to_be32(uint32_t v) return ( ( v & 0xff ) << 24 ) | ( ( v & 0xff00 ) << 8 ) | ( ( v & 0xff0000 ) >> 8 ) | ( ( v & 0xff000000 ) >> 24 ) ; write_u32 ( data , tag_table_offset + 4 , tag_data_offset ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_table_offset + 8 , 20 ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_data_offset , XYZ_TYPE ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_data_offset + 8 , double_to_s15Fixed16Number ( colorants . m [ 0 ] [ index ] ) ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_data_offset + 12 , double_to_s15Fixed16Number ( colorants . m [ 1 ] [ index ] ) ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_data_offset + 16 , double_to_s15Fixed16Number ( colorants . m [ 2 ] [ index ] ) ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_table_offset , TAG_TRC [ index ] ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_table_offset + 4 , tag_data_offset ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_table_offset + 8 , 14 ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_data_offset , CURVE_TYPE ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , tag_data_offset + 8 , 1 ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u16 ( data , tag_data_offset + 12 , float_to_u8Fixed8Number ( gamma ) ); static uint16_t float_to_u8Fixed8Number(float a) if ( a > ( 255.f + 255.f / 256 ) )  if ( a < 0.f )  return floorf ( a * 256.f + .5f ) ; static void write_u16(void *mem, size_t offset, uint16_t value) * ( ( uint16_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be16 ( value ); static be16 cpu_to_be16(uint16_t v) return ( ( v & 0xff ) << 8 ) | ( ( v & 0xff00 ) >> 8 ) ; write_u32 ( data , 0 , length ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , 12 , DISPLAY_DEVICE_PROFILE ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , 16 , RGB_SIGNATURE ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , 20 , XYZ_SIGNATURE ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , 64 , QCMS_INTENT_PERCEPTUAL ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); write_u32 ( data , ICC_PROFILE_HEADER_LENGTH , 6 ); static void write_u32(void *mem, size_t offset, uint32_t value) * ( ( uint32_t * ) ( ( unsigned char * ) mem + offset ) ) = cpu_to_be32 ( value ); * mem = data; 
static int arcmsr_queue_command_lck(struct scsi_cmnd void (* done)(struct scsi_cmnd *)) struct Scsi_Host * host = cmd -> device -> host ; struct AdapterControlBlock * acb = ( struct AdapterControlBlock * ) host -> hostdata ; int target = cmd -> device -> id ; uint8_t scsicmd = cmd -> cmnd [ 0 ] ; if ( ( scsicmd == SYNCHRONIZE_CACHE ) || ( scsicmd == SEND_DIAGNOSTIC ) )  if ( target == 16 )  arcmsr_handle_virtual_command ( acb , cmd ); static void arcmsr_handle_virtual_command(struct AdapterControlBlock struct scsi_cmnd *cmd) switch ( cmd -> cmnd [ 0 ] )  if ( arcmsr_iop_message_xfer ( acb , cmd ) )  static int arcmsr_iop_message_xfer(struct AdapterControlBlock struct scsi_cmnd *cmd) unsigned short use_sg ; int retvalue = 0 , transfer_len = 0 ; uint32_t controlcode = ( uint32_t ) cmd -> cmnd [ 5 ] << 24 | ( uint32_t ) cmd -> cmnd [ 6 ] << 16 | ( uint32_t ) cmd -> cmnd [ 7 ] << 8 | ( uint32_t ) cmd -> cmnd [ 8 ] ; struct scatterlist * sg ; use_sg = scsi_sg_count ( cmd ); sg = scsi_sglist ( cmd ); if ( use_sg > 1 )  transfer_len += sg -> length; if ( transfer_len > sizeof ( struct CMD_MESSAGE_FIELD ) )  switch ( controlcode )  uint8_t * pQbuffer , * ptmpuserbuffer ; uint8_t * pQbuffer = acb -> rqbuffer ; acb -> acb_flags |= ACB_F_MESSAGE_RQBUFFER_CLEARED; acb -> rqbuf_getIndex = 0; acb -> rqbuf_putIndex = 0; memset ( pQbuffer , 0 , ARCMSR_MAX_QBUFFER ); uint8_t * pQbuffer = acb -> wqbuffer ; acb -> acb_flags |= ( ACB_F_MESSAGE_WQBUFFER_CLEARED | ACB_F_MESSAGE_WQBUFFER_READED ); acb -> wqbuf_getIndex = 0; acb -> wqbuf_putIndex = 0; memset ( pQbuffer , 0 , ARCMSR_MAX_QBUFFER ); uint8_t * pQbuffer ; acb -> acb_flags |= ACB_F_MESSAGE_RQBUFFER_CLEARED; acb -> rqbuf_getIndex = 0; acb -> rqbuf_putIndex = 0; pQbuffer = acb -> rqbuffer; memset ( pQbuffer , 0 , sizeof ( struct QBUFFER ) ); memset ( pQbuffer , 0 , sizeof ( struct QBUFFER ) ); 
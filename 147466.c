tvbuff_t CVE_2011_2174_VULN_tvb_uncompress(tvbuff_t *tvb, const int offset, int comprlen) guint bytes_out = 0 ; guint8 * uncompr = NULL ; gint wbits = MAX_WBITS ; if ( tvb == NULL )  compr = tvb_memdup ( tvb , offset , comprlen ); if ( ! compr )  bufsiz = tvb_length_remaining ( tvb , offset ) * 2; bufsiz = CLAMP ( bufsiz , TVB_Z_MIN_BUFSIZ , TVB_Z_MAX_BUFSIZ ); next = compr; strm = g_new0 ( z_stream , 1 ); strm -> next_in = next; strm -> avail_in = comprlen; strmbuf = g_malloc0 ( bufsiz ); strm -> next_out = strmbuf; strm -> avail_out = bufsiz; err = inflateInit2 ( strm , wbits ); inits_done = 1; if ( err != Z_OK )  while ( 1 )  memset ( strmbuf , '\0' , bufsiz ); strm -> next_out = strmbuf; strm -> avail_out = bufsiz; err = inflate ( strm , Z_SYNC_FLUSH ); if ( err == Z_OK || err == Z_STREAM_END )  guint bytes_pass = bufsiz - strm -> avail_out ; if ( uncompr == NULL )  uncompr = g_memdup ( strmbuf , bytes_pass ); guint8 * new_data = g_malloc0 ( bytes_out + bytes_pass ) ; g_memmove ( new_data , uncompr , bytes_out ); g_memmove ( ( new_data + bytes_out ) , strmbuf , bytes_pass ); g_free ( uncompr ); uncompr = new_data; bytes_out += bytes_pass; if ( err == Z_STREAM_END )  if ( err == Z_BUF_ERROR )  if ( uncompr != NULL )  if ( err == Z_DATA_ERROR && inits_done == 1 && uncompr == NULL && ( * compr == 0x1f ) && ( * ( compr + 1 ) == 0x8b ) )  Bytef * c = compr + 2 ; if ( * c == Z_DEFLATED )  c ++; inflateEnd ( strm ); g_free ( strm ); g_free ( strmbuf ); flags = * c; c += 7; if ( flags & ( 1 << 2 ) )  gint xsize = ( gint ) ( * c | ( * ( c + 1 ) << 8 ) ) ; c += xsize; if ( flags & ( 1 << 3 ) )  while ( ( c - compr ) < comprlen && * c != '\0' )  c ++; c ++; if ( flags & ( 1 << 4 ) )  while ( ( c - compr ) < comprlen && * c != '\0' )  c ++; c ++; next = c; if ( c - compr > comprlen )  comprlen -= ( int ) ( c - compr ); inits_done ++; if ( err == Z_DATA_ERROR && uncompr == NULL && inits_done <= 3 )  wbits = - MAX_WBITS; strm -> next_in = next; strm -> avail_in = comprlen; memset ( strmbuf , '\0' , bufsiz ); strm -> next_out = strmbuf; strm -> avail_out = bufsiz; err = inflateInit2 ( strm , wbits ); inits_done ++; if ( err != Z_OK )  g_free ( uncompr ); if ( uncompr == NULL )  printf ( "bytes  in: %u\nbytes out: %u\n\n" , bytes_in , bytes_out ); if ( uncompr != NULL )  uncompr_tvb = tvb_new_real_data ( ( guint8 * ) uncompr , bytes_out , bytes_out ); tvb_set_free_cb ( uncompr_tvb , g_free ); return uncompr_tvb ; 
static sg_add_device(struct device *cl_dev, struct class_interface *cl_intf) struct scsi_device * scsidp = to_scsi_device ( cl_dev -> parent ) ; struct gendisk * disk ; disk = alloc_disk ( 1 ); if ( ! disk )  disk -> major = SCSI_GENERIC_MAJOR; cdev = cdev_alloc ( ); if ( ! cdev )  sdp = sg_alloc ( disk , scsidp ); static Sg_device sg_alloc(struct gendisk *disk, struct scsi_device *scsidp) Sg_device * sdp ; int error ; u32 k ; sdp = kzalloc ( sizeof ( Sg_device ) , GFP_KERNEL ); if ( ! sdp )  error = idr_alloc ( & sg_index_idr , sdp , 0 , SG_MAX_DEVS , GFP_NOWAIT ); if ( error < 0 )  k = error; sprintf ( disk -> disk_name , "sg%d" , k ); disk -> first_minor = k; sdp -> disk = disk; sdp -> device = scsidp; mutex_init ( & sdp -> open_rel_lock ); INIT_LIST_HEAD ( & sdp -> sfds ); init_waitqueue_head ( & sdp -> open_wait ); atomic_set ( & sdp -> detaching , 0 ); rwlock_init ( & sdp -> sfd_lock ); sdp -> sg_tablesize = queue_max_segments ( q ); sdp -> index = k; kref_init ( & sdp -> d_ref ); kfree ( sdp ); return sdp ; 
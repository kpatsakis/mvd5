bool const sp<DataSource> &source, String8 *mimeType, float sp<AMessage> *meta) if ( BetterSniffMPEG4 ( source , mimeType , confidence , meta ) )  static bool const sp<DataSource> &source, String8 *mimeType, float sp<AMessage> *meta) static const off64_t kMaxScanOffset = 128l l off64_t offset = 0l l bool foundGoodFileType = false ; bool done = false ; while ( ! done && offset < kMaxScanOffset )  uint32_t hdr [ 2 ] ; if ( source -> readAt ( offset , hdr , 8 ) < 8 )  return false ; uint64_t chunkSize = ntohl ( hdr [ 0 ] ) ; off64_t chunkDataOffset = offset + 8 ; if ( chunkSize == 1 )  if ( source -> readAt ( offset + 8 , & chunkSize , 8 ) < 8 )  return false ; chunkSize = ntoh64 ( chunkSize ); chunkDataOffset += 8; if ( chunkSize < 16 )  return false ; if ( chunkSize < 8 )  return false ; if ( chunkDataSize < 8 )  return false ; uint32_t numCompatibleBrands = ( chunkDataSize - 8 ) / 4 ; for (size_t i = 0; i < numCompatibleBrands + 2; ++i) if ( i == 1 )  uint32_t brand ; if ( source -> readAt ( chunkDataOffset + 4 * i , & brand , 4 ) < 4 )  return false ; brand = ntohl ( brand ); if ( isCompatibleBrand ( brand ) )  static bool isCompatibleBrand(uint32_t fourcc) static const uint32_t kCompatibleBrands [ ] FOURCC ( 'i' , 's' , 'o' , 'm' ) FOURCC ( 'i' , 's' , 'o' , '2' ) FOURCC ( 'a' , 'v' , 'c' , '1' ) FOURCC ( '3' , 'g' , 'p' , '4' ) FOURCC ( 'm' , 'p' , '4' , '1' ) FOURCC ( 'm' , 'p' , '4' , '2' ) , for (size_t i = i < sizeof(kCompatibleBrands) / ++i) if ( kCompatibleBrands [ i ] == fourcc )  return true ; return false ; foundGoodFileType = true; if ( ! foundGoodFileType )  return false ; done = true; offset += chunkSize; if ( ! foundGoodFileType )  return false ; return true ; if ( LegacySniffMPEG4 ( source , mimeType , confidence ) )  static bool const sp<DataSource> &source, String8 *mimeType, float *confidence) uint8_t header [ 8 ] ; ssize_t n = source -> readAt ( 4 , header , sizeof ( header ) ) ; if ( n < ( ssize_t ) sizeof ( header ) )  if ( ! memcmp ( header , "ftyp3gp" , 7 ) || ! memcmp ( header , "ftypmp42" , 8 ) || ! memcmp ( header , "ftyp3gr6" , 8 ) || ! memcmp ( header , "ftyp3gs6" , 8 ) || ! memcmp ( header , "ftyp3ge6" , 8 ) || ! memcmp ( header , "ftyp3gg6" , 8 ) || ! memcmp ( header , "ftypisom" , 8 ) || ! memcmp ( header , "ftypM4V " , 8 ) || ! memcmp ( header , "ftypM4A " , 8 ) || ! memcmp ( header , "ftypf4v " , 8 ) || ! memcmp ( header , "ftypkddi" , 8 ) || ! memcmp ( header , "ftypM4VP" , 8 ) )  
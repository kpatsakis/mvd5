static void sysbus_esp_mem_write(void *opaque, hwaddr uint64_t val, unsigned int size) SysBusESPState * sysbus = opaque ; uint32_t saddr ; saddr = addr >> sysbus -> it_shift; esp_reg_write ( & sysbus -> esp , saddr , val ); void esp_reg_write(ESPState *s, uint32_t saddr, uint64_t val) switch ( saddr )  s -> tchi_written = true; s -> rregs [ ESP_RSTAT ] &= ~STAT_TC; if ( s -> do_cmd )  if ( s -> ti_size == TI_BUFSZ - 1 )  s -> ti_size ++; s -> ti_buf [ s -> ti_wptr ++ ] = val & 0xff; s -> rregs [ saddr ] = val; if ( val & CMD_DMA )  s -> dma = 1; s -> rregs [ ESP_TCLO ] = s -> wregs [ ESP_TCLO ]; s -> rregs [ ESP_TCMID ] = s -> wregs [ ESP_TCMID ]; s -> rregs [ ESP_TCHI ] = s -> wregs [ ESP_TCHI ]; s -> dma = 0; switch ( val & CMD_CMD )  s -> rregs [ ESP_RINTR ] = INTR_FC; s -> rregs [ ESP_RSEQ ] = 0; s -> rregs [ ESP_RFLAGS ] = 0; esp_soft_reset ( s ); static void esp_soft_reset(ESPState *s) esp_hard_reset ( s ); void esp_hard_reset(ESPState *s) memset ( s -> rregs , 0 , ESP_REGS ); memset ( s -> wregs , 0 , ESP_REGS ); s -> tchi_written = 0; s -> ti_size = 0; s -> ti_rptr = 0; s -> ti_wptr = 0; s -> dma = 0; s -> do_cmd = 0; s -> dma_cb = NULL; s -> rregs [ ESP_CFG1 ] = 7; 
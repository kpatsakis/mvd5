static int airspy_start_streaming(struct vb2_queue *vq, unsigned int count) struct airspy * s = vb2_get_drv_priv ( vq ) ; int ret ; if ( ! s -> udev )  s -> sequence = 0; ret = airspy_alloc_stream_bufs ( s ); static int airspy_alloc_stream_bufs(struct airspy *s) s -> buf_num = 0; s -> buf_size = BULK_BUFFER_SIZE; for (s->buf_num = 0; s->buf_num < MAX_BULK_BUFS; s->buf_num++) s -> buf_list [ s -> buf_num ] = usb_alloc_coherent ( s -> udev , BULK_BUFFER_SIZE , GFP_ATOMIC , & s -> dma_addr [ s -> buf_num ] ); if ( ! s -> buf_list [ s -> buf_num ] )  return - ENOMEM ; return 0 ; if ( ret )  ret = airspy_alloc_urbs ( s ); static int airspy_alloc_urbs(struct airspy *s) int i , j ; for (i = 0; i < MAX_BULK_BUFS; i++) s -> urb_list [ i ] = usb_alloc_urb ( 0 , GFP_ATOMIC ); if ( ! s -> urb_list [ i ] )  return - ENOMEM ; s -> urb_list [ i ] -> transfer_flags = URB_NO_TRANSFER_DMA_MAP; s -> urb_list [ i ] -> transfer_dma = s -> dma_addr [ i ]; s -> urbs_initialized ++; return 0 ; if ( ret )  ret = airspy_submit_urbs ( s ); static int airspy_submit_urbs(struct airspy *s) int i , ret ; for (i = 0; i < s->urbs_initialized; i++) ret = usb_submit_urb ( s -> urb_list [ i ] , GFP_ATOMIC ); if ( ret )  return ret ; s -> urbs_submitted ++; return 0 ; if ( ret )  ret = airspy_ctrl_msg ( s , CMD_RECEIVER_MODE , 1 , 0 , NULL , 0 ); static int airspy_ctrl_msg(struct airspy *s, u8 request, u16 value, u16 u8 *data, u16 size) u8 requesttype ; switch ( request )  requesttype = ( USB_TYPE_VENDOR | USB_DIR_OUT ); requesttype = ( USB_TYPE_VENDOR | USB_DIR_IN ); if ( ! ( requesttype & USB_DIR_IN ) )  memcpy ( s -> buf , data , size ); ret = usb_control_msg ( s -> udev , pipe , request , requesttype , value , index , s -> buf , size , 1000 ); airspy_dbg_usb_control_msg ( s -> dev , request , requesttype , value , index , s -> buf , size ); if ( ret < 0 )  dev_err ( s -> dev , "usb_control_msg() failed %d request %02x\n" , ret , request ); memcpy ( data , s -> buf , size ); return ret ; 
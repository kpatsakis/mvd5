static int32_t scsi_target_send_command(SCSIRequest *req, uint8_t *buf) SCSITargetReq * r = DO_UPCAST ( SCSITargetReq , req , req ) ; switch ( buf [ 0 ] )  if ( ! scsi_target_emulate_report_luns ( r ) )  if ( ! scsi_target_emulate_inquiry ( r ) )  r -> len = scsi_device_get_sense ( r -> req . dev , r -> buf , MIN ( req -> cmd . xfer , r -> buf_len ) , ( req -> cmd . buf [ 1 ] & 1 ) == 0 ); if ( r -> req . dev -> sense_is_ua )  r -> req . dev -> sense_len = 0; r -> req . dev -> sense_is_ua = false; if ( ! r -> len )  scsi_req_complete ( req , GOOD ); void scsi_req_complete(SCSIRequest *req, int status) req -> status = status; if ( status == GOOD )  req -> sense_len = 0; if ( req -> sense_len )  req -> dev -> sense_len = 0; req -> dev -> sense_is_ua = false; scsi_req_dequeue ( req ); static void scsi_req_dequeue(SCSIRequest *req) req -> retry = false; if ( req -> enqueued )  req -> enqueued = false; scsi_req_unref ( req ); void scsi_req_unref(SCSIRequest *req) assert ( req -> refcount > 0 ); 